name: Extract melsec_mc v0.4.13 (history-only)

on:
  workflow_dispatch:

jobs:
  extract:
    name: Extract melsec_mc@v0.4.13
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository (full)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Ensure Python and pip
        run: |
          sudo apt-get update -y
          sudo apt-get install -y python3 python3-pip git

      - name: Install git-filter-repo
        run: |
          python3 -m pip install --upgrade pip
          python3 -m pip install git-filter-repo

      - name: Prepare workspace for filter (use checked-out workspace)
        run: |
          set -euo pipefail
          TMPDIR=$(mktemp -d)
          echo "workdir=$TMPDIR" > workdir.env
          # ensure full history and tags are present in the checked-out workspace
          git -C "$GITHUB_WORKSPACE" fetch --prune --unshallow || true
          git -C "$GITHUB_WORKSPACE" fetch --tags origin || true
          echo "Available tags:"; git -C "$GITHUB_WORKSPACE" tag -l | sed -n '1,50p' || true
          # create a branch at tag v0.4.13 in the workspace
          if git -C "$GITHUB_WORKSPACE" rev-parse --verify refs/tags/v0.4.13 >/dev/null 2>&1; then
            git -C "$GITHUB_WORKSPACE" checkout -b extract-v0.4.13 v0.4.13
          else
            echo "Tag v0.4.13 not found in repository" >&2
            exit 2
          fi
          # copy workspace to a separate dir to run git-filter-repo (avoid mutating runner workspace)
          git -C "$GITHUB_WORKSPACE" repack -ad || true
          git clone --no-hardlinks --dissociate "$GITHUB_WORKSPACE" "$TMPDIR/repo"
          cd "$TMPDIR/repo"
          git branch --show-current

      - name: Run git-filter-repo to extract melsec_mc
        run: |
          set -euo pipefail
          TMPDIR=$(cat workdir.env | sed -n 's/^workdir=//p')
          cd "$TMPDIR/repo"
          # rewrite history keeping only the path 'melsec_mc' and move it to root
          python3 -m git_filter_repo --force --refs refs/heads/extract-v0.4.13 --path melsec_mc --path-rename melsec_mc/:
          echo "Filter exit: $?"

      - name: Pack filtered repo and upload
        run: |
          set -euo pipefail
          TMPDIR=$(cat workdir.env | sed -n 's/^workdir=//p')
          cd "$TMPDIR/repo"
          # ensure filtered refs are present and show recent commits
          # try to force-checkout the filtered branch so work tree is consistent
          git fetch --all || true
          if git rev-parse --verify refs/heads/extract-v0.4.13 >/dev/null 2>&1; then
            git checkout --force extract-v0.4.13 || git checkout --detach $(git rev-parse --verify refs/heads/extract-v0.4.13)
          else
            # if branch missing, try to detach to the tag's commit
            git checkout --detach || true
          fi
          # If branch is yet-to-be-born (no commits), find any commit and point HEAD there
          if git rev-parse --verify --quiet HEAD >/dev/null 2>&1; then
            : # HEAD exists
          else
            TIP=$(git rev-list --all -n 1 || true)
            if [ -n "$TIP" ]; then
              git checkout --detach "$TIP" || true
              git branch -f main "$TIP" || true
              git checkout main || true
            fi
          fi
          git --no-pager log --oneline -n 10 || true
          git repack -ad || true

          # create a stable copy of the filtered repo and tar that copy to avoid "file changed as we read it"
          OUTDIR="$TMPDIR/out"
          rm -rf "$OUTDIR"
          mkdir -p "$OUTDIR"
          # create a bare clone (stable, no working-tree checkout) and tar that
          git clone --bare . "$OUTDIR/repo_bare.git"
          cd "$OUTDIR/repo_bare.git"

          OUT="${GITHUB_RUN_ID:-run}_melsec_mc_v0.4.13.tar.gz"
          tar -czf "$OUT" .

          # move artifact to workspace so upload-artifact can find it reliably
          mv "$OUT" "$GITHUB_WORKSPACE/"
          echo "artifact=$GITHUB_WORKSPACE/$OUT" > "$GITHUB_WORKSPACE/artifact.env" || true

      - name: Upload extracted artifact
        uses: actions/upload-artifact@v4
        with:
          name: melsec_mc-v0.4.13-repo
          path: |
            ${{ github.workspace }}/*melsec_mc_v0.4.13.tar.gz

      - name: Show guidance
        run: |
          echo "The artifact 'melsec_mc-v0.4.13-repo' contains the filtered repository tarball."
          echo "Download and inspect it locally. If acceptable, you can replace the target repo or unpack it and push to a new remote."
